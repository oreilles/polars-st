# This file is autogenerated by maturin v1.7.1
# To update, run
#
#    maturin generate-ci github
#
name: Release

on:
  push:
    tags: ['*']
  workflow_dispatch:

permissions:
  contents: read

jobs:
  linux:
    runs-on: ${{ matrix.platform.runner }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - runner: ubuntu-24.04
            target: x86_64
          - runner: ubuntu-24.04-arm
            target: aarch64
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: 3.x
      - name: Install build dependencies
        run: wget -qO- https://apt.llvm.org/llvm.sh | sudo bash -s -- 20
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist
          container: off
        env:
          CC: "clang-20"
          CXX: "clang++-20"
          AR: "llvm-ar-20"
          CFLAGS: "-O3 -flto -fvisibility=hidden"
          CXXFLAGS: "-O3 -flto -fvisibility=hidden"
          RUSTFLAGS: "-C strip=symbols -C codegen-units=1 -Clto=thin -Clinker-plugin-lto -C embed-bitcode -Clink-arg=-fuse-ld=lld -Clinker=clang-20"
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-${{ matrix.platform.target }}
          path: dist

  macos:
    runs-on: ${{ matrix.platform.runner }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - runner: macos-13
            target: x86_64
            brew_prefix: /usr/local
          - runner: macos-14
            target: aarch64
            brew_prefix: /opt/homebrew
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: 3.x
      - name: Install build dependencies
        run: brew install llvm lld
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-${{ matrix.platform.target }}
          path: dist
        env:
          CC: ${{ matrix.platform.brew_prefix }}/opt/llvm/bin/clang
          CXX: ${{ matrix.platform.brew_prefix }}/opt/llvm/bin/clang++
          AR: ${{ matrix.platform.brew_prefix }}/opt/llvm/bin/llvm-ar
          CFLAGS: -O3 -flto -fvisibility=hidden
          CXXFLAGS: -O3 -flto -fvisibility=hidden
          RUSTFLAGS: -C strip=symbols -C codegen-units=1 -Clto=thin -Clinker-plugin-lto -C embed-bitcode -Clink-arg=-fuse-ld=lld -Clinker=${{ github.workspace }}/macos-linker.sh

  windows:
    runs-on: ${{ matrix.platform.runner }}
    strategy:
      matrix:
        platform:
          - runner: windows-latest
            target: x64
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: 3.x
          architecture: ${{ matrix.platform.target }}
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist
        env:
          CFLAGS: "-O3 -flto -fvisibility=hidden"
          CXXFLAGS: "-O3 -flto -fvisibility=hidden"
          RUSTFLAGS: "-C strip=symbols -C codegen-units=1 -C lto=thin -C linker-plugin-lto -C embed-bitcode -C linker=lld-link.exe"
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-windows-${{ matrix.platform.target }}
          path: dist
      
  sdist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist
      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: wheels-sdist
          path: dist
